#:import Factory kivy.factory.Factory

WindowManager:
    MainScreen:
    SecondScreen:
    ThirdScreen:
    FourthScreen:
    FifthScreen:
    SixthScreen:
    SeventhScreen:
    EigthsScreen:
    NinethScreen:


<IDPopup@Popup>
    auto_dismiss: False
    size_hint: (0.7, 0.7)
    pos_hint: {"top": 0.9}
    title: "Is this your subject?"
    
    BoxLayout:
        orientation: "vertical"
        
        Image:
            source: "subjectID.png"
            size: self.texture_size
            pos_hint: {"top": 0.5}
            
        Label:
            text: "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
            multiline: True
            text_size: None, None
            size: self.texture_size
            halign: 'left'
            valign: 'middle' 
            
        BoxLayout:
            orientation: "horizontal"
            
            Button:
                text: "Yes"
                on_release: 
                    app.root.current = "selection"
                on_press: root.dismiss()
                size_hint: (0.5, 0.2)
            
            Button:
                text: "No"
                on_release: root.dismiss()
                size_hint: (0.5, 0.2)


<MainScreen>:
    name: "main"
    # This Window displays main menu
    
    GridLayout:
        cols: 1
        size: root.width, root.height
        
        # HEADER
        Image:
            source: 'header.png'
            size: self.texture_size 
            size_hint_y: None
            height: 400
            pos_hint: {"top":1}
                
        # BODY    
        Label: 
            text: "Welcome to the Raspberry Pi 4 Toolbox for behavioral experiments (RPi4Toolbox). "
            font_size: 40
            multiline: True
            size_hint: (1,.3)
            text_size: 1500, None
            size: self.texture_size
            halign: 'justify'
            valign: 'middle'
            pos_hint: {"top":1}
            
        Label: 
            text: "Choose one of the options below to (1) start an experiment, (2) check or edit the experimental protocol, (3) review the progress, or (4) to have a look at the subject IDs"
            multiline: True
            text_size: 1500, None
            size_hint: (1,.3)
            size: self.texture_size
            halign: 'justify'
            valign: 'middle'
              
        BoxLayout:
            orientation: "horizontal"
            spacing: 10
            padding: 10
            
            Button:
                text: "Start Experiment"
                font_size: 35
                size_hint: (1,.8)
                on_release: 
                    app.root.current = "experiment"
                    root.manager.transition.direction = "left"
                
            Button:
                text: "Experimental Protocol"
                font_size: 35
                size_hint: (1,.8)
                on_release: 
                    app.root.current = "protocol"
                    root.manager.transition.direction = "left"
                
            Button:
                text: "Check Progress"
                font_size: 35
                size_hint: (1,.8)
                on_release: 
                    app.root.current = "progress"
                    root.manager.transition.direction = "left"
                
            Button:
                text: "Subject IDs"
                font_size: 35
                size_hint: (1,.8)
                on_release: 
                    app.root.current = "IDs"
                    root.manager.transition.direction = "left"
        
        Label: 
            text: "Click on the footer below for help."
            multiline: True
            font_size: 25
            text_size: 1500, None
            size: self.texture_size
            size_hint: (1,.2)
            halign: 'right'
            valign: 'middle'
            
            
        # FOOTER
        Button:
            markup: True
            text: "[b]RPi4Toolbox[/b] (C) 2021 GuillermoHidalgoGadea.com"
            on_release: root.homepage()
            size_hint: (1,.2)
        
    
<SecondScreen>:
    name: "experiment"
    # This Window starts the experiment
    
    # Define variables 
    subject: subject
    experimenter: experimenter
    
    GridLayout:
        cols: 1
        size: root.width, root.height
        
        # HEADER        
        Image:
            source: 'header.png'
            size: self.texture_size
            size_hint_y: None
            height: 400
            pos_hint: {"top":1}
                
        # BODY
        Label: 
            text: "To start the experiment please enter the following information:"
            multiline: True
            text_size: 1500, None
            size_hint: (1,.3)
            size: self.texture_size
            halign: 'justify'
            valign: 'middle'
            pos_hint: {"top": 1}
                       
        BoxLayout:
            orientation: "horizontal"
            spacing: 10
            padding: 10
            
            Label: 
                text:""
        
            Label:
                text: "Subject ID:"
                font_size: 30
                size_hint: (None,.5)
                width: 500
                pos_hint: {"top": 0}
                    
            TextInput:
                id: subject
                multiline: False
                size_hint: (None,.5)
                width: 500
                pos_hint: {"top": 0}
                
            Label: 
                text:""
                        
        BoxLayout:
            orientation: "horizontal"
            spacing: 10
            padding: 10
                
            Label: 
                text:""
                
            Label:
                text: "Experimenter:"
                font_size: 30
                size_hint: (None,.5)
                width: 500
                pos_hint: {"top": .5}
                        
            TextInput:
                id: experimenter
                multiline: False
                size_hint: (None,.5)
                width: 500
                pos_hint: {"top": .5}
                
            Label: 
                text:""
                size_hint: (1,.2)
        
        BoxLayout:
            orientation: "vertical"   
                     
            Button:
                text: "Okay"
                font_size: 30
                on_release: Factory.IDPopup().open()
                pos_hint: {"top": 1, "center_x": 0.5}
                size_hint: (None, None)
                width: 200
                height: 50
                
        Label: 
            text:""
        
                    
        # FOOTER
        Button:
            text: "Exit"
            font_size: 30
            on_release: 
                app.root.current = "main"
                root.manager.transition.direction = "right"
            size_hint: (1,.5)
            

<ThirdScreen>:
    name: "selection"
    # This Window assigns upcoming trial
    
    GridLayout:
        cols: 1
        size: root.width, root.height
        
        # HEADER
        Image:
            source: 'header.png'
            size: self.texture_size 
            size_hint_y: None
            height: 400
            pos_hint: {"top":1}
                
        # BODY
        GridLayout:
            cols: 2
            
            Label:
                text: "This is the progress of the selected subject: Last session was session 4 on 2021-01-01, total trials 431. Performance so far: 34% of 80% criteria"
                multiline: True
                text_size: 700, None
                pos_hint: {"top":1}
                size: self.texture_size
                halign: 'justify'
                valign: 'top'
                  
            BoxLayout:
                orientation: "vertical"
                spacing: 10
                padding: 10
                
                Button:
                    text: "Next Session is XYZ"
                    font_size: 40
                    size_hint: (.7, .5)
                    pos_hint: {"center_x": .5}
                    on_release: 
                        app.root.current = "instruction"
                        root.manager.transition.direction = "left"
                    
                Button:
                    text: "Manual selection"
                    font_size: 40
                    size_hint: (.6, .4)
                    pos_hint: {"center_x": .5}
                
        Label:
            text: ""
            size_hint: (1, 0.2)
        
        # FOOTER
        Button:
            text: "Exit"
            font_size: 30
            on_release: 
                app.root.current = "main"
                root.manager.transition.direction = "right"
            size_hint: (1,.12)
            

<FourthScreen>:
    name: "instruction"
    # This Window gives instruction for upcoming trial
    
    GridLayout:
        cols: 1
        size: root.width, root.height
        
        # HEADER
        Image:
            source: 'header.png'
            size: self.texture_size 
            size_hint_y: None
            height: 400
            pos_hint: {"top":1}
                
        # BODY
        GridLayout:
            cols: 2
            
            Label:
                text: "Please proceed to adjust the experimental setup for following trial: Trial X Session Y Group B. This trial will use both pecking keys and the feeder. Please position key R at 0.25cm and key L ar 2.35cm from the pecking line."
                multiline: True
                text_size: 700, None
                pos_hint: {"top":1}
                size: self.texture_size
                halign: 'justify'
                valign: 'top'
                
            Label:
                text: "Remember to start the cameras and check the feeder before starting the experiment. Try to remain outside the visual range of the subject and avoid noises during the session. Some more helpful advice here"
                multiline: True
                text_size: 700, None
                pos_hint: {"top":1}
                size: self.texture_size
                halign: 'justify'
                valign: 'top'
                  
        BoxLayout:
            orientation: "vertical"  
            
            Button:
                text: "Start"
                font_size: 30
                pos_hint: {"top": 1, "center_x": 0.5}
                size_hint: (None, None)
                width: 200
                height: 50 
                on_release:
                    app.root.current = "countdown"
                    root.manager.transition.direction = "left"
        
        Label:
            text: ""
            size_hint: (1, 0.2)
        
        # FOOTER
        Button:
            text: "Exit"
            font_size: 30
            on_release: 
                app.root.current = "main"
                root.manager.transition.direction = "right"
            size_hint: (1,.3)


<FifthScreen>:
    name: "countdown"
    # This Window starts experiment countdown with popup
    
    GridLayout:
        cols: 1
        size: root.width, root.height
        
        # HEADER
        Image:
            source: 'header.png'
            size: self.texture_size 
            size_hint_y: None
            height: 400
            pos_hint: {"top":1}
                
        # BODY
        GridLayout:
            cols: 2
            
            Label:
                text: "Proceed to place the subject in the starting area for the habituatino phase. Start the countdown on the right to start the trial.\n Be prepared to release the subject after the countdown hits 0!"
                multiline: True
                text_size: 700, None
                pos_hint: {"top":1}
                size: self.texture_size
                halign: 'justify'
                valign: 'top'
                  
            BoxLayout:
                orientation: "vertical"
                spacing: 10
                padding: 10
                
                Image:
                    source: "countdown.png"
                    size: self.texture_size 
                    
                Button:
                    text: "Start Trial"
                    font_size: 40
                    size_hint: (.6, .4)
                    pos_hint: {"center_x": .5}
                    
                Button:
                    text: "Continue"
                    font_size: 40
                    size_hint: (.6, .4)
                    pos_hint: {"center_x": .5}
                    on_release: 
                        app.root.current = "trial"
                        root.manager.transition.direction = "left"
        
        Label:
            text: ""
            size_hint: (1, 0.2)
        
        # FOOTER
        Button:
            text: "Exit"
            font_size: 30
            on_release: 
                app.root.current = "main"
                root.manager.transition.direction = "right"
            size_hint: (1,.12)


<SixthScreen>:
    name: "trial"
    # This Window shows trial end statistics
    
    GridLayout:
        cols: 1
        size: root.width, root.height
        
        # HEADER
        Image:
            source: 'header.png'
            size: self.texture_size 
            size_hint_y: None
            height: 400
            pos_hint: {"top":1}
                
        # BODY
        BoxLayout:
            orientation: "vertical"  
            
            Label: 
                text: "Trial Finished!"
                font_size: 40
                multiline: True
                size_hint: (1,.3)
                text_size: 1500, None
                size: self.texture_size
                halign: 'justify'
                valign: 'middle'
                pos_hint: {"center_x": 0.5, "top": 1}
            
        GridLayout:
            cols: 2
            
            Label:
                text: "Subject P007 finished the trial X from session Y. please proceed to move the subject bach to the start area for the next trial."
                multiline: True
                text_size: 700, None
                pos_hint: {"top":1}
                size: self.texture_size
                halign: 'justify'
                valign: 'top'
                
                      
            Label:
                text: "Subject P007 finished the trial X from session Y with the following outcome: performance 50% from 80% critirium, choice A optimal, time to choice: 54 sec."
                multiline: True
                text_size: 700, None
                pos_hint: {"top":1}
                size: self.texture_size
                halign: 'justify'
                valign: 'top'
             
                    
        BoxLayout:
            orientation: "vertical"  
            
            Button:
                text: "Continue"
                size_hint: (None, None)
                width: 200
                height: 50
                pos_hint: {"center_x": 0.5, "top": 0.5}
                on_release: 
                    app.root.current = "selection"
                    root.manager.transition.direction = "right"
                
        Label:
            text: ""
            size_hint: (1, 0.2)
        
        # FOOTER
        Button:
            text: "Exit"
            font_size: 30
            on_release: 
                app.root.current = "main"
                root.manager.transition.direction = "right"
            size_hint: (1,.3)
    
    
<SeventhScreen>:
    name: "protocol"
    # This Window shows editable exp Protocol
    
    GridLayout:
        cols: 1
        size: root.width, root.height
        
        # HEADER
        Image:
            source: 'header.png'
            size: self.texture_size 
            size_hint_y: None
            height: 400
            pos_hint: {"top":1}
                
        # BODY
        GridLayout:
            cols: 2
            
            BoxLayout:
                orientation: "vertical"
                
                Label:
                    text: "This is a description of the Experimental protocol chosen for this experiment. Laalal alalal alalala laaalalalalal alala la lal. Should the information be outdated, feel free to edit the .yaml document below. Choose one of the options below to (1) start an experiment, (2) check or edit the experimental protocol, (3) review the progress, or (4) to have a look at the subject IDs"
                    multiline: True
                    text_size: 700, None
                    pos_hint: {"top":1}
                    size: self.texture_size
                    halign: 'justify'
                    valign: 'top'
                
                Button:
                    text: "Edit"
                    on_release: root.edit()
                    size_hint: (None, None)
                    width: 200
                    height: 50
                    pos_hint: {"center_x": 0.5, "top":0.5}
                    
            
            Image:
                source: "experimentalsetup.png"
                size: self.texture_size
                
        Label:
            text: ""
            size_hint: (1, 0.2)
        
        # FOOTER
        Button:
            text: "Exit"
            font_size: 30
            on_release: 
                app.root.current = "main"
                root.manager.transition.direction = "right"
            size_hint: (1,.12)
    
    
<EigthsScreen>:
    name: "progress"
    # This Window shows exp Progress
    
    GridLayout:
        cols: 1
        size: root.width, root.height
        
        # HEADER
        Image:
            source: 'header.png'
            size: self.texture_size 
            size_hint_y: None
            height: 400
            pos_hint: {"top":1}
                
        # BODY
        GridLayout:
            cols: 2
            
            BoxLayout:
                orientation: "vertical"
                
                Label:
                    text: "This is a description of the Experimental protocol chosen for this experiment. Laalal alalal alalala laaalalalalal alala la lal. Should the information be outdated, feel free to edit the .yaml document below. Choose one of the options below to (1) start an experiment, (2) check or edit the experimental protocol, (3) review the progress, or (4) to have a look at the subject IDs"
                    multiline: True
                    text_size: 700, None
                    pos_hint: {"top":1}
                    size: self.texture_size
                    halign: 'justify'
                    valign: 'top'
                
                Button:
                    text: "Edit"
                    on_release: root.edit()
                    size_hint: (None, None)
                    width: 200
                    height: 50
                    pos_hint: {"center_x": 0.5, "top":0.5}
                    
            
            Image:
                source: "experimentalsetup.png"
                size: self.texture_size
                
        Label:
            text: ""
            size_hint: (1, 0.2)
        
        # FOOTER
        Button:
            text: "Exit"
            font_size: 30
            on_release: 
                app.root.current = "main"
                root.manager.transition.direction = "right"
            size_hint: (1,.12)
            
    
<NinethScreen>:
    name: "IDs"
    # This Window shows subject IDs
    
    # Define variables 
    content: content
    
    GridLayout:
        cols: 1
        size: root.width, root.height
        
        # HEADER
        Image:
            source: 'header.png'
            size: self.texture_size 
            size_hint_y: None
            height: 400
            pos_hint: {"top":1}
                
        # BODY
        GridLayout:
            cols: 2
                
            ScrollView:
                size: self.size
                do_scroll_x: False
                do_scroll_y: True
                scroll_timeout: 250
                scroll_distance: 20
                step: 30
                
                GridLayout:
                    cols: 3
                    id: content
                    size_hint_y: None 
                    row_default_height: '150dp'
                    row_force_default: True
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                    BoxLayout:
                        orientation: "horizontal"
                        
                        Image:
                            source: "subjectID.png"
                            size: self.texture_size

                        Label:
                            size_hint_y: None
                            height: self.texture_size[1]
                            text_size: self.width, None
                            padding: 10, 10
                            text:
                                "Label: P007 \n Sex: Male \n Age: 2021-01-09 \n Features: very pretty"
                    
                
        Label:
            text: ""
            size_hint: (1, 0.2)
        
        # FOOTER
        Button:
            text: "Exit"
            font_size: 30
            on_release: 
                app.root.current = "main"
                root.manager.transition.direction = "right"
            size_hint: (1,.12)
    